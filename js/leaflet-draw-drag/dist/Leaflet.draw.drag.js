(function(t,e){if(typeof define==="function"&&define.amd){define(["leaflet"],t)}else if(typeof exports==="object"){module.exports=t(require("leaflet"))}if(typeof e!=="undefined"&&e.L){t(e.L)}})(function(t){/**
 * Leaflet vector features drag functionality
 * @author Alexander Milevski <info@w8r.name>
 * @preserve
 */
t.Path.include({_transform:function(t){if(this._renderer){if(t){this._renderer.transformPath(this,t)}else{this._renderer._resetTransformPath(this);this._update()}}return this},_onMouseClick:function(t){if(this.dragging&&this.dragging.moved()||this._map.dragging&&this._map.dragging.moved()){return}this._fireMouseEvent(t)}});var e={mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"};var a={mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"};function i(t,e){var a=t.x-e.x,i=t.y-e.y;return Math.sqrt(a*a+i*i)}t.Handler.PathDrag=t.Handler.extend({statics:{DRAGGING_CLS:"leaflet-path-draggable"},initialize:function(t){this._path=t;this._matrix=null;this._startPoint=null;this._dragStartPoint=null;this._mapDraggingWasEnabled=false},addHooks:function(){this._path.on("mousedown",this._onDragStart,this);this._path.options.className=this._path.options.className?this._path.options.className+" "+t.Handler.PathDrag.DRAGGING_CLS:t.Handler.PathDrag.DRAGGING_CLS;if(this._path._path){t.DomUtil.addClass(this._path._path,t.Handler.PathDrag.DRAGGING_CLS)}},removeHooks:function(){this._path.off("mousedown",this._onDragStart,this);this._path.options.className=this._path.options.className.replace(new RegExp("\\s+"+t.Handler.PathDrag.DRAGGING_CLS),"");if(this._path._path){t.DomUtil.removeClass(this._path._path,t.Handler.PathDrag.DRAGGING_CLS)}},moved:function(){return this._path._dragMoved},_onDragStart:function(i){var r=i.originalEvent._simulated?"touchstart":i.originalEvent.type;this._mapDraggingWasEnabled=false;this._startPoint=i.containerPoint.clone();this._dragStartPoint=i.containerPoint.clone();this._matrix=[1,0,0,1,0,0];t.DomEvent.stop(i.originalEvent);t.DomUtil.addClass(this._path._renderer._container,"leaflet-interactive");t.DomEvent.on(document,a[r],this._onDrag,this).on(document,e[r],this._onDragEnd,this);if(this._path._map.dragging.enabled()){this._path._map.dragging.disable();this._mapDraggingWasEnabled=true}this._path._dragMoved=false;if(this._path._popup){this._path._popup._close()}this._replaceCoordGetters(i)},_onDrag:function(e){t.DomEvent.stop(e);var a=e.touches&&e.touches.length>=1?e.touches[0]:e;var i=this._path._map.mouseEventToContainerPoint(a);if(e.type==="touchmove"&&!this._path._dragMoved){var r=this._dragStartPoint.distanceTo(i);if(r<=this._path._map.options.tapTolerance){return}}var s=i.x;var n=i.y;var o=s-this._startPoint.x;var h=n-this._startPoint.y;if(o||h){if(!this._path._dragMoved){this._path._dragMoved=true;this._path.fire("dragstart",e);this._path.bringToFront()}this._matrix[4]+=o;this._matrix[5]+=h;this._startPoint.x=s;this._startPoint.y=n;this._path.fire("predrag",e);this._path._transform(this._matrix);this._path.fire("drag",e)}},_onDragEnd:function(e){var a=this._path._map.mouseEventToContainerPoint(e);var r=this.moved();if(r){this._transformPoints(this._matrix);this._path._updatePath();this._path._project();this._path._transform(null);t.DomEvent.stop(e)}t.DomEvent.off(document,"mousemove touchmove",this._onDrag,this);t.DomEvent.off(document,"mouseup touchend",this._onDragEnd,this);this._restoreCoordGetters();if(r){this._path.fire("dragend",{distance:i(this._dragStartPoint,a)});var s=this._path._containsPoint;this._path._containsPoint=t.Util.falseFn;t.Util.requestAnimFrame(function(){t.DomEvent.skipped({type:"click"});this._path._containsPoint=s},this)}this._matrix=null;this._startPoint=null;this._dragStartPoint=null;this._path._dragMoved=false;if(this._mapDraggingWasEnabled){if(r)t.DomEvent.fakeStop({type:"click"});this._path._map.dragging.enable()}},_transformPoints:function(e,a){var i=this._path;var r,s,n;var o=t.point(e[4],e[5]);var h=i._map.options.crs;var _=h.transformation;var p=h.scale(i._map.getZoom());var g=h.projection;var d=_.untransform(o,p).subtract(_.untransform(t.point(0,0),p));var l=!a;i._bounds=new t.LatLngBounds;if(i._point){a=g.unproject(g.project(i._latlng)._add(d));if(l){i._latlng=a;i._point._add(o)}}else if(i._rings||i._parts){var f=i._rings||i._parts;var u=i._latlngs;a=a||u;if(!t.Util.isArray(u[0])){u=[u];a=[a]}for(r=0,s=f.length;r<s;r++){a[r]=a[r]||[];for(var m=0,c=f[r].length;m<c;m++){n=u[r][m];a[r][m]=g.unproject(g.project(n)._add(d));if(l){i._bounds.extend(u[r][m]);f[r][m]._add(o)}}}}return a},_replaceCoordGetters:function(){if(this._path.getLatLng){this._path.getLatLng_=this._path.getLatLng;this._path.getLatLng=t.Util.bind(function(){return this.dragging._transformPoints(this.dragging._matrix,{})},this._path)}else if(this._path.getLatLngs){this._path.getLatLngs_=this._path.getLatLngs;this._path.getLatLngs=t.Util.bind(function(){return this.dragging._transformPoints(this.dragging._matrix,[])},this._path)}},_restoreCoordGetters:function(){if(this._path.getLatLng_){this._path.getLatLng=this._path.getLatLng_;delete this._path.getLatLng_}else if(this._path.getLatLngs_){this._path.getLatLngs=this._path.getLatLngs_;delete this._path.getLatLngs_}}});t.Handler.PathDrag.makeDraggable=function(e){e.dragging=new t.Handler.PathDrag(e);return e};t.Path.prototype.makeDraggable=function(){return t.Handler.PathDrag.makeDraggable(this)};t.Path.addInitHook(function(){if(this.options.draggable){this.options.interactive=true;if(this.dragging){this.dragging.enable()}else{t.Handler.PathDrag.makeDraggable(this);this.dragging.enable()}}else if(this.dragging){this.dragging.disable()}});t.SVG.include({_resetTransformPath:function(t){t._path.setAttributeNS(null,"transform","")},transformPath:function(t,e){t._path.setAttributeNS(null,"transform","matrix("+e.join(" ")+")")}});t.SVG.include(!t.Browser.vml?{}:{_resetTransformPath:function(t){if(t._skew){t._skew.on=false;t._path.removeChild(t._skew);t._skew=null}},transformPath:function(e,a){var i=e._skew;if(!i){i=t.SVG.create("skew");e._path.appendChild(i);i.style.behavior="url(#default#VML)";e._skew=i}var r=a[0].toFixed(8)+" "+a[1].toFixed(8)+" "+a[2].toFixed(8)+" "+a[3].toFixed(8)+" 0 0";var s=Math.floor(a[4]).toFixed()+", "+Math.floor(a[5]).toFixed()+"";var n=this._path.style;var o=parseFloat(n.left);var h=parseFloat(n.top);var _=parseFloat(n.width);var p=parseFloat(n.height);if(isNaN(o))o=0;if(isNaN(h))h=0;if(isNaN(_)||!_)_=1;if(isNaN(p)||!p)p=1;var g=(-o/_-.5).toFixed(8)+" "+(-h/p-.5).toFixed(8);i.on="f";i.matrix=r;i.origin=g;i.offset=s;i.on=true}});function r(){return true}t.Canvas.include({_resetTransformPath:function(t){if(!this._containerCopy)return;delete this._containerCopy;if(t._containsPoint_){t._containsPoint=t._containsPoint_;delete t._containsPoint_;this._requestRedraw(t)}},transformPath:function(e,a){var i=this._containerCopy;var s=this._ctx,n;var o=t.Browser.retina?2:1;var h=this._bounds;var _=h.getSize();var p=h.min;if(!i){i=this._containerCopy=document.createElement("canvas");n=i.getContext("2d");i.width=o*_.x;i.height=o*_.y;this._removePath(e);this._redraw();n.translate(o*h.min.x,o*h.min.y);n.drawImage(this._container,0,0);this._initPath(e);e._containsPoint_=e._containsPoint;e._containsPoint=r}s.save();s.clearRect(p.x,p.y,_.x*o,_.y*o);s.setTransform(1,0,0,1,0,0);s.restore();s.save();s.drawImage(this._containerCopy,0,0,_.x,_.y);s.transform.apply(s,a);this._drawing=true;e._updatePath();this._drawing=false;s.restore()}});/**
 * Drag feature functionality for Leaflet.draw
 * @preserve
 * @license MIT
 * @author Alexander Milevski <info@w8r.name>
 */
t.EditToolbar.Edit.MOVE_MARKERS=false;t.EditToolbar.Edit.include({initialize:function(e,a){if(a&&a.selectedPathOptions){t.EditToolbar.Edit.MOVE_MARKERS=!!a.selectedPathOptions.moveMarkers}this._initialize(e,a)},_initialize:t.EditToolbar.Edit.prototype.initialize});t.Edit.SimpleShape.include({_updateMoveMarker:function(){if(this._moveMarker){this._moveMarker.setLatLng(this._getShapeCenter())}},_getShapeCenter:function(){return this._shape.getBounds().getCenter()},_createMoveMarker:function(){if(t.EditToolbar.Edit.MOVE_MARKERS){this._moveMarker=this._createMarker(this._getShapeCenter(),this.options.moveIcon)}}});t.Edit.SimpleShape.mergeOptions({moveMarker:false});t.Edit.Circle.include({addHooks:function(){if(this._shape._map){this._map=this._shape._map;this._shape.setStyle(this._shape.options.editing);if(!this._markerGroup){this._enableDragging();this._initMarkers()}this._shape._map.addLayer(this._markerGroup)}},removeHooks:function(){this._shape.setStyle(this._shape.options.original);if(this._shape._map){for(var t=0,e=this._resizeMarkers.length;t<e;t++){this._unbindMarker(this._resizeMarkers[t])}this._disableDragging();this._resizeMarkers=null;this._map.removeLayer(this._markerGroup);delete this._markerGroup}this._map=null},_createMoveMarker:t.Edit.SimpleShape.prototype._createMoveMarker,_resize:function(t){var e=this._shape.getLatLng();var a=e.distanceTo(t);this._shape.setRadius(a);this._updateMoveMarker();this._map.fire("draw:editresize",{layer:this._shape})},_enableDragging:function(){if(!this._shape.dragging){this._shape.dragging=new t.Handler.PathDrag(this._shape)}this._shape.dragging.enable();this._shape.on("dragstart",this._onStartDragFeature,this).on("dragend",this._onStopDragFeature,this)},_disableDragging:function(){this._shape.dragging.disable();this._shape.off("dragstart",this._onStartDragFeature,this).off("dragend",this._onStopDragFeature,this)},_onStartDragFeature:function(){this._shape._map.removeLayer(this._markerGroup);this._shape.fire("editstart")},_onStopDragFeature:function(){var t=this._shape.getLatLng();this._resizeMarkers[0].setLatLng(this._getResizeMarkerPoint(t));this._shape._map.addLayer(this._markerGroup);this._updateMoveMarker();this._fireEdit()}});t.Edit.Rectangle.include({addHooks:function(){if(this._shape._map){this._map=this._shape._map;this._shape.setStyle(this._shape.options.editing);if(!this._markerGroup){this._enableDragging();this._initMarkers()}this._shape._map.addLayer(this._markerGroup)}},removeHooks:function(){this._shape.setStyle(this._shape.options.original);if(this._shape._map){this._shape._map.removeLayer(this._markerGroup);this._disableDragging();delete this._markerGroup;delete this._markers}this._map=null},_resize:function(e){this._shape.setBounds(t.latLngBounds(e,this._oppositeCorner));this._updateMoveMarker();this._shape._map.fire("draw:editresize",{layer:this._shape})},_onMarkerDragEnd:function(e){this._toggleCornerMarkers(1);this._repositionCornerMarkers();t.Edit.SimpleShape.prototype._onMarkerDragEnd.call(this,e)},_enableDragging:function(){if(!this._shape.dragging){this._shape.dragging=new t.Handler.PathDrag(this._shape)}this._shape.dragging.enable();this._shape.on("dragstart",this._onStartDragFeature,this).on("dragend",this._onStopDragFeature,this)},_disableDragging:function(){this._shape.dragging.disable();this._shape.off("dragstart",this._onStartDragFeature,this).off("dragend",this._onStopDragFeature,this)},_onStartDragFeature:function(){this._shape._map.removeLayer(this._markerGroup);this._shape.fire("editstart")},_onStopDragFeature:function(){var t=this._shape;for(var e=0,a=t._latlngs.length;e<a;e++){for(var i=0,r=t._latlngs[e].length;i<r;i++){var s=this._resizeMarkers[i];s.setLatLng(t._latlngs[e][i]);s._origLatLng=t._latlngs[e][i];if(s._middleLeft){s._middleLeft.setLatLng(this._getMiddleLatLng(s._prev,s))}if(s._middleRight){s._middleRight.setLatLng(this._getMiddleLatLng(s,s._next))}}}this._shape._map.addLayer(this._markerGroup);this._updateMoveMarker();this._repositionCornerMarkers();this._fireEdit()}});t.Edit.PolyVerticesEdit.include({__createMarker:t.Edit.PolyVerticesEdit.prototype._createMarker,__removeMarker:t.Edit.PolyVerticesEdit.prototype._removeMarker,addHooks:function(){var e=this._poly;if(!(e instanceof t.Polygon)){e.options.fill=false;if(e.options.editing){e.options.editing.fill=false}}e.setStyle(e.options.editing);if(this._poly._map){this._map=this._poly._map;if(!this._markerGroup){this._enableDragging();this._initMarkers();this._createMoveMarker()}this._poly._map.addLayer(this._markerGroup)}},_createMoveMarker:function(){if(t.EditToolbar.Edit.MOVE_MARKERS&&this._poly instanceof t.Polygon){this._moveMarker=new t.Marker(this._getShapeCenter(),{icon:this.options.moveIcon});this._moveMarker.on("mousedown",this._delegateToShape,this);this._markerGroup.addLayer(this._moveMarker)}},_delegateToShape:function(e){var a=this._shape||this._poly;var i=e.target;a.fire("mousedown",t.Util.extend(e,{containerPoint:t.DomUtil.getPosition(i._icon).add(a._map._getMapPanePos())}))},_getShapeCenter:function(){return this._poly.getCenter()},removeHooks:function(){var t=this._poly;if(t.options.original){t.setStyle(t.options.original)}if(this._poly._map){this._poly._map.removeLayer(this._markerGroup);this._disableDragging();delete this._markerGroup;delete this._markers}this._map=null},_enableDragging:function(){if(!this._poly.dragging){this._poly.dragging=new t.Handler.PathDrag(this._poly)}this._poly.dragging.enable();this._poly.on("dragstart",this._onStartDragFeature,this).on("dragend",this._onStopDragFeature,this)},_disableDragging:function(){this._poly.dragging.disable();this._poly.off("dragstart",this._onStartDragFeature,this).off("dragend",this._onStopDragFeature,this)},_onStartDragFeature:function(t){this._poly._map.removeLayer(this._markerGroup);this._poly.fire("editstart")},_onStopDragFeature:function(e){var a=this._poly;var i=a._latlngs;if(!t.Util.isArray(i[0])){i=[i]}for(var r=0,s=i.length;r<s;r++){for(var n=0,o=i[r].length;n<o;n++){var h=this._markers[n];h.setLatLng(i[r][n]);h._origLatLng=i[r][n];if(h._middleLeft){h._middleLeft.setLatLng(this._getMiddleLatLng(h._prev,h))}if(h._middleRight){h._middleRight.setLatLng(this._getMiddleLatLng(h,h._next))}}}this._poly._map.addLayer(this._markerGroup);t.Edit.SimpleShape.prototype._updateMoveMarker.call(this);this._fireEdit()},_updateMoveMarker:t.Edit.SimpleShape.prototype._updateMoveMarker,_createMarker:function(t,e){var a=this.__createMarker(t,e);a.on("dragstart",this._hideMoveMarker,this).on("dragend",this._showUpdateMoveMarker,this);return a},_removeMarker:function(t){this.__removeMarker(t);t.off("dragstart",this._hideMoveMarker,this).off("dragend",this._showUpdateMoveMarker,this)},_hideMoveMarker:function(){if(this._moveMarker){this._markerGroup.removeLayer(this._moveMarker)}},_showUpdateMoveMarker:function(){if(this._moveMarker){this._markerGroup.addLayer(this._moveMarker);this._updateMoveMarker()}}});t.Edit.PolyVerticesEdit.prototype.options.moveIcon=new t.DivIcon({iconSize:new t.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-move"});t.Edit.PolyVerticesEdit.mergeOptions({moveMarker:false})},window);